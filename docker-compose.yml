version: "3.9"

services:
  # Hazelcast cluster nodes for distributed in-memory index
  hazelcast1:
    image: hazelcast/hazelcast:5.3.6
    container_name: hazelcast1
    environment:
      - JAVA_OPTS=-Dhazelcast.config=/opt/hazelcast/config/hazelcast.xml
    volumes:
      - ./hazelcast.xml:/opt/hazelcast/config/hazelcast.xml:ro
    networks:
      - search-net
    ports:
      - "5701:5701"

  hazelcast2:
    image: hazelcast/hazelcast:5.3.6
    container_name: hazelcast2
    environment:
      - JAVA_OPTS=-Dhazelcast.config=/opt/hazelcast/config/hazelcast.xml
    volumes:
      - ./hazelcast.xml:/opt/hazelcast/config/hazelcast.xml:ro
    networks:
      - search-net
    depends_on:
      - hazelcast1

  hazelcast3:
    image: hazelcast/hazelcast:5.3.6
    container_name: hazelcast3
    environment:
      - JAVA_OPTS=-Dhazelcast.config=/opt/hazelcast/config/hazelcast.xml
    volumes:
      - ./hazelcast.xml:/opt/hazelcast/config/hazelcast.xml:ro
    networks:
      - search-net
    depends_on:
      - hazelcast1

  # ActiveMQ message broker
  # Used by ingestion to publish events and indexing to consume them.
  activemq:
    image: rmohr/activemq:latest
    container_name: activemq
    ports:
      - "61616:61616"  # JMS protocol
      - "8161:8161"    # Web console
    environment:
      - ACTIVEMQ_ADMIN_LOGIN=admin
      - ACTIVEMQ_ADMIN_PASSWORD=admin
    networks:
      - search-net
    restart: unless-stopped

  # Search service instances (3 replicas for load balancing)
  search1:
    build: ./search_service
    container_name: search1
    environment:
      - PORT=8080
      - HAZELCAST_HOST=hazelcast1
      - HAZELCAST_PORT=5701
    networks:
      - search-net
    depends_on:
      - hazelcast1
      - hazelcast2
      - hazelcast3
    restart: unless-stopped

  search2:
    build: ./search_service
    container_name: search2
    environment:
      - PORT=8080
      - HAZELCAST_HOST=hazelcast1
      - HAZELCAST_PORT=5701
    networks:
      - search-net
    depends_on:
      - hazelcast1
      - hazelcast2
      - hazelcast3
    restart: unless-stopped

  search3:
    build: ./search_service
    container_name: search3
    environment:
      - PORT=8080
      - HAZELCAST_HOST=hazelcast1
      - HAZELCAST_PORT=5701
    networks:
      - search-net
    depends_on:
      - hazelcast1
      - hazelcast2
      - hazelcast3
    restart: unless-stopped

  # Nginx load balancer
  nginx:
    image: nginx:alpine
    container_name: nginx_lb
    ports:
      - "8000:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - search-net
    depends_on:
      - search1
      - search2
      - search3
    restart: unless-stopped

  # Ingestion service (crawler)
  ingestion:
    build: ./ingestion_service
    container_name: ingestion
    ports:
      - "7001:7001"
    volumes:
      - ./data_repository:/app/data_repository
    networks:
      - search-net
    depends_on:
      - activemq
    environment:
      - ACTIVEMQ_URL=tcp://activemq:61616
      - REPLICATION_FACTOR=1
      - JAVA_TOOL_OPTIONS=-DdataRepo=data_repository/datalake_node1
    restart: unless-stopped

  # Indexing service with embedded Hazelcast node
  indexing:
    build: ./indexing_service
    container_name: indexing
    ports:
      - "7002:7002"
    volumes:
      - ./data_repository:/app/data_repository
    environment:
      - ACTIVEMQ_URL=tcp://activemq:61616
      - ACTIVEMQ_QUEUE=books.ingested
      - PORT=7002
      - HZ_MEMBERS=hazelcast1:5701,hazelcast2:5701,hazelcast3:5701
      - HZ_CLUSTER=search-cluster
      - NODE_ID=indexer-node1
    networks:
      - search-net
    depends_on:
      - activemq
      - hazelcast1
      - hazelcast2
      - hazelcast3
    restart: unless-stopped

networks:
  search-net:
    driver: bridge
